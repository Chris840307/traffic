<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
"http://www.w3.org/TR/html4/loose.dtd">
<!--#include virtual="traffic/Common/DB.ini"-->
<!--#include virtual="traffic/Common/AllFunction.inc"-->
<!--#include virtual="traffic/Common/Login_Check.asp"-->
<!--#include virtual="traffic/Common/banner.asp"-->
<!--#include virtual="traffic/Common/DCIURL.ini"-->
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=big5">
<title>各式清冊/舉發單列印</title>
<!--#include virtual="traffic/Common/css.txt"-->
</head>
<%
'檢查是否可進入本系統
RecordDate=split(gInitDT(date),"-")
if request("DB_Selt")="BatchSelt" then
	strwhere="":tmp_BatchNumber="":Sys_BatchNumber=""
	if UCase(request("Sys_BatchNumber"))<>"" then
		tmp_BatchNumber=split(UCase(request("Sys_BatchNumber")),",")
		for i=0 to Ubound(tmp_BatchNumber)
			if i>0 then Sys_BatchNumber=trim(Sys_BatchNumber)&","
			if i=0 then
				Sys_BatchNumber=trim(Sys_BatchNumber)&tmp_BatchNumber(i)
			else
				Sys_BatchNumber=trim(Sys_BatchNumber)&"'"&tmp_BatchNumber(i)
			end if
			if i<Ubound(tmp_BatchNumber) then Sys_BatchNumber=trim(Sys_BatchNumber)&"'"
		next
		strwhere=" and a.BatchNumber in('"&Sys_BatchNumber&"')"
	end if
	if trim(request("Sys_BillNo1"))<>"" and trim(request("Sys_BillNo2"))<>"" then
		strwhere=strwhere&" and a.BillNo between '"&trim(request("Sys_BillNo1"))&"' and '"&trim(request("Sys_BillNo2"))&"'"
	end if
end if
DB_Display=request("DB_Display")
if DB_Display="show" then
	if trim(strwhere)<>"" then
		strwhereToPrintCarData=strwhere

		strSQL="select a.SN,a.BillSN,a.RecordDate,a.ReturnMarkType,a.FileName,a.DCIReturnStatusID,a.ExchangeTypeID,a.DciErrorCarData,a.DCIErrorIDdata,b.ChName,a.BillNo,a.CarNo,a.BillTypeID,a.EXCHANGEDATE,a.RecordMemberID,a.seqNo,a.BatchNumber,c.Content as BillTypeName,d.DCIReturn,d.StatusContent,d.DCIRETURNSTATUS,e.DCIActionName,f.DCIreturn as CarErrorSN,f.StatusContent as CarErrorContent,g.DCIreturn as DCIErrorSN,g.StatusContent as DCIErrorContent from DCILog a,MemberData b,(select * from DCIcode where TypeID=2) c,DCIReturnStatus d,(select distinct DCIACTIONID,DCIACTIONNAME from DCIReturnStatus) e,(select * from DciReturnStatus where DciActionID='WE') f,(select * from DciReturnStatus where DciActionID='WE') g where a.ExchangeTypeID=d.DCIActionID(+) and a.DCIReturnStatusID=d.DCIReturn(+) and a.RecordMemberID=b.MemberID(+) and a.BillTypeID=c.ID(+) and a.ExchangeTypeID=e.DCIActionID(+) and a.DCIERRORCARDATA=f.DciReturn(+) and a.DCIERRORIDDATA=g.DciReturn(+)"&strwhere&" order by a.ExchangeDate DESC"

		set rsfound=conn.execute(strSQL)	
		if trim(request("PBillSN"))="" then
			strSQL="select a.BillSN,a.RecordDate,a.RecordMemberID from DCILog a,MemberData b,(select * from DCIcode where TypeID=2) c,DCIReturnStatus d,(select distinct DCIACTIONID,DCIACTIONNAME from DCIReturnStatus) e,(select * from DciReturnStatus where DciActionID='WE') f,(select * from DciReturnStatus where DciActionID='WE') g where a.ExchangeTypeID=d.DCIActionID(+) and a.DCIReturnStatusID=d.DCIReturn(+) and a.RecordMemberID=b.MemberID(+) and a.BillTypeID=c.ID(+) and a.ExchangeTypeID=e.DCIActionID(+) and a.DCIERRORCARDATA=f.DciReturn(+) and a.DCIERRORIDDATA=g.DciReturn(+)"&strwhere&" order by a.RecordMemberID,a.RecordDate"
			set rssn=conn.execute(strSQL)
			BillSN=""
			while Not rssn.eof
				if trim(BillSN)<>"" then BillSN=trim(BillSN)&","
				BillSN=BillSN&rssn("BillSN")
				rssn.movenext
			wend
			rssn.close
		end if
		
		strSQL="select count(*) as cnt from DCILog a,MemberData b,(select * from DCIcode where TypeID=2) c,DCIReturnStatus d,(select distinct DCIACTIONID,DCIACTIONNAME from DCIReturnStatus) e,(select * from DciReturnStatus where DciActionID='WE') f,(select * from DciReturnStatus where DciActionID='WE') g where a.ExchangeTypeID=d.DCIActionID(+) and a.DCIReturnStatusID=d.DCIReturn(+) and a.RecordMemberID=b.MemberID(+) and a.BillTypeID=c.ID(+) and a.ExchangeTypeID=e.DCIActionID(+) and a.DCIERRORCARDATA=f.DciReturn(+) and a.DCIERRORIDDATA=g.DciReturn(+) and d.DCIRETURNSTATUS='1'"&strwhere
		set chksuess=conn.execute(strSQL)
		filsuess=Cint(chksuess("cnt"))
		chksuess.close

		strSQL="select count(*) as cnt from DCILog a,MemberData b,(select * from DCIcode where TypeID=2) c,DCIReturnStatus d,(select distinct DCIACTIONID,DCIACTIONNAME from DCIReturnStatus) e,(select * from DciReturnStatus where DciActionID='WE') f,(select * from DciReturnStatus where DciActionID='WE') g where a.ExchangeTypeID=d.DCIActionID(+) and a.DCIReturnStatusID=d.DCIReturn(+) and a.RecordMemberID=b.MemberID(+) and a.BillTypeID=c.ID(+) and a.ExchangeTypeID=e.DCIActionID(+) and a.DCIERRORCARDATA=f.DciReturn(+) and a.DCIERRORIDDATA=g.DciReturn(+) and d.DCIRETURNSTATUS='-1'"&strwhere
		set chksuess=conn.execute(strSQL)
		fildel=Cint(chksuess("cnt"))
		chksuess.close

		strCnt="select count(*) as cnt from DCILog a,MemberData b,(select * from DCIcode where TypeID=2) c,DCIReturnStatus d,(select distinct DCIACTIONID,DCIACTIONNAME from DCIReturnStatus) e,(select * from DciReturnStatus where DciActionID='WE') f,(select * from DciReturnStatus where DciActionID='WE') g where a.ExchangeTypeID=d.DCIActionID(+) and a.DCIReturnStatusID=d.DCIReturn(+) and a.RecordMemberID=b.MemberID(+) and a.BillTypeID=c.ID(+) and a.ExchangeTypeID=e.DCIActionID(+) and a.DCIERRORCARDATA=f.DciReturn(+) and a.DCIERRORIDDATA=g.DciReturn(+)"&strwhere

		set Dbrs=conn.execute(strCnt)
		DBsum=Cint(Dbrs("cnt"))
		Dbrs.close
		tmpSQL=strwhere
	else
		DB_Display=""
		Response.write "<script>"
		Response.Write "alert('必須有查詢條件！');"
		Response.write "</script>"
	end if
end if
%>
<body>
<form name=myForm method="post">
<table width="100%" border="0">
	<tr>
		<td bgcolor="#FFCC33"><span class="style3">各式清冊/舉發單列印</span></td>
	</tr>
	<tr>
		<td bgcolor="#CCCCCC">
			<table width="100%" border="0" cellpadding="5" cellspacing="1" bgcolor="#FFFFFF">
				<tr>
					<td nowrap>
						作業批號 
						<input name="Sys_BatchNumber" type="text" class="btn1" value="<%=UCase(request("Sys_BatchNumber"))%>" size="35">
						
						<!--<br>
						舉發單號
						<input name="Sys_BillNo1" type="text" class="btn1" value="<%=UCase(request("Sys_BillNo1"))%>" size="10" maxlength="9">
						至　舉發單號
						<input name="Sys_BillNo2" type="text" class="btn1" value="<%=UCase(request("Sys_BillNo2"))%>" size="10" maxlength="9">-->
						<input type="button" name="btnSelt" value="查詢" onclick="funSelt('BatchSelt');"<%
						'1:查詢 ,2:新增 ,3:修改 ,4:刪除
						if CheckPermission(233,1)=false then
							response.write " disabled"
						end if
						%>>
						<input type="button" name="cancel" value="清除" onClick="location='AllBillPrint.asp'">
						
						<br>
						(多個批號同時處理，各批號請用,隔開。如：95A361,95A382,95A486）
						<br>
						
						<img src="space.gif" width="15" height="8"></img><strong>( 查詢 <%=DBsum%> 筆紀錄 , <%=filsuess%>筆成功. <%=fildel%> 筆失敗 <%=DBsum-filsuess-fildel%>筆未處理. )</strong>
					</td>
				</tr>
			</table>
		</td>
	</tr>
	<tr>
		<td height="35" bgcolor="#FFDD77" align="left">
			<!--<span class="style3">
			DCI檔案名稱
			<input name="textfield42324" type="text" value="" size="14" maxlength="13">
			</span>-->
			<span class="style3"><img src="space.gif" width="20" height="8"></span>
			<input type="button" name="Submit4234222" value="車籍資料" onclick="funchgCarDataList()">
			<span class="style3"><img src="space.gif" width="13" height="8"></span>
			<input type="button" name="btnprintBill" value="列印違規通知單" onclick="funPrintStyle()">
			<span class="style3"><img src="space.gif" width="13" height="8"></span>
			<input type="button" name="Submit47335" value="有效清冊" onclick="funValidSendList()">
			<span class="style3"><img src="space.gif" width="13" height="8"></span>
			<input type="button" name="Submit4234" value="逕舉移送清冊" onclick="funReportSendList()">
			<span class="style3"><img src="space.gif" width="13" height="8"></span>
			<input type="button" name="Submit42342" value="大宗掛號清冊" onclick="funMailList()">
			<span class="style3"><img src="space.gif" width="60" height="8"></span>
			<input type="button" name="Submit4233" value="退件清冊" onclick="funReturnSendList()">
		<br>
			<%'if trim(request("Sys_ExchangeTypeID"))="W" then '入案%>
			<span class="style3"><img src="space.gif" width="130" height="8"></span>
			<input type="button" name="btnprintBill" value="列印送達證書" onclick="funUrgeList()">
			<span class="style3"><img src="space.gif" width="35" height="8"></span>
			<input type="button" name="Submit43635" value="無效清冊" onclick="funUselessSendList()">			
			<span class="style3"><img src="space.gif" width="13" height="8"></span>
			<input type="button" name="Submit4335" value="攔停移送清冊" onclick="funStopSendList()">
			<span class="style3"><img src="space.gif" width="13" height="8"></span>
			<input type="button" name="Submit423423" value="郵費單" onclick="funMailMoneyList()">
			<span class="style3"><img src="space.gif" width="128" height="8"></span>
			<input type="button" name="Submit4233" value="寄存送達清冊" onclick="funStoreSendList()">
		<br>
			
			<span class="style3"><img src="space.gif" width="307" height="8"></span>
			<input type="button" name="Submit43635" value="結案清冊" onclick="funCaseCloseSendList()">
			<span class="style3"><img src="space.gif" width="170" height="8"></span>
			<input type="button" name="Submit43635" value="大宗條碼資料註記" onclick="funBillMailInfoMark()">
			<span class="style3"><img src="space.gif" width="15" height="8"></span>
			<input type="button" name="Submit4232" value="公示送達清冊" onclick="funGovSendList()">
	</td>
  </tr>
  <tr>
    <td><p align="center">&nbsp;</p>    </td></tr>
</table>
<input type="button" name="Submit4232" value="違規舉發單 / 清冊 列印設定說明" onclick="funPrintDetail()"> 各式清冊皆為 A4 直印
<input type="Hidden" name="DB_Selt" value="<%=request("DB_Selt")%>">
<input type="Hidden" name="DB_Display" value="<%=DB_Display%>">
<input type="Hidden" name="DB_state" value="">
<input type="Hidden" name="SN" value="">
<input type="Hidden" name="DB_Move" value="<%=DBcnt%>">
<input type="Hidden" name="DB_Cnt" value="<%=DBsum%>">
<input type="Hidden" name="PBillSN" value="<%
	if trim(request("PBillSN"))<>"" then
		response.write request("PBillSN")
	else
		response.write BillSN
	end if%>">
<input type="Hidden" name="printStyle" value="">
<input type="Hidden" name="Sys_MailDate" value="">
<input type="Hidden" name="Sys_JudeAgentSex" value="">
</form>
</body>
</html>
<script type="text/javascript" src="../js/date.js"></script>
<script language="javascript">
var winopen;
function UnitMan(tmpMemID){
	if(myForm.Sys_BillUnitID.value!=''){
		if(tmpMemID==''){
		runServerScript("Bill_UnitAdd.asp?UnitID="+myForm.Sys_BillUnitID.value+"&MemberID="+myForm.Sys_BillMem.value);
		}else{
		runServerScript("Bill_UnitAdd.asp?UnitID="+myForm.Sys_BillUnitID.value+"&MemberID="+tmpMemID);
		}
	}
}
function funSelt(DBKind){
	var error=0;
	if(DBKind=='BatchSelt'){
		if(myForm.Sys_BatchNumber.value==""){
			error=1;
			alert("作業批號必須填寫!!");
		}else{
			myForm.PBillSN.value="";
			myForm.DB_Move.value="";
			myForm.DB_Selt.value=DBKind;
			myForm.DB_Display.value='show';
			myForm.submit();
		}
	}
}
function newWin(url,win,w,h,l,t,sBar,mBar,res,full){
	winopen=window.open(url,win,"width="+w+",height="+h+",left="+l+",top="+t+",scrollbars="+sBar+",menubar="+mBar+",resizable="+res+",fullscreen="+full+",status=yes,toolbar=yes");
	winopen.focus();
	return win;
}
function funDataDetail(SN){
	UrlStr="ViewBillBaseData_Car.asp?BillSn="+SN;
	newWin(UrlStr,"inputWin",900,550,50,10,"yes","yes","yes","no");
}
function funUpdate(SN){
	UrlStr="../BillKeyIn/BillKeyIn_Car_Report_Update.asp?BillSN="+SN;
	newWin(UrlStr,"inputWin",900,550,50,10,"yes","yes","yes","no");
}
function funDel(SN){
	myForm.SN.value=SN;
	myForm.DB_state.value="Del";
	myForm.submit();
}
function funsubmit(){
	winopen.close();
	if(myForm.printStyle.value=='0'){
		/*window.parent.frames("mainFrame").location="BillPrints.asp";
		myForm.action="BillPrints.asp";*/
		UrlStr="BillPrints.asp";
	}else if(myForm.printStyle.value=='2'){
		/*window.parent.frames("mainFrame").location="BillPrints_a4.asp";
		myForm.action="BillPrints_a4.asp";*/
		UrlStr="BillPrints_a4.asp";
	}else if(myForm.printStyle.value=='1'){
		UrlStr="BillPrints_legalA4.asp";
	}
	/*myForm.target="mainFrame";
	myForm.submit();
	myForm.action="";
	myForm.target="";*/
	newWin(UrlStr,"JudeBat",920,600,50,10,"yes","yes","yes","no");
	myForm.action=UrlStr;
	myForm.target="JudeBat";
	myForm.submit();
	myForm.action="";
	myForm.target="";
	setTimeout('funchgprint()',2000);
	
}
function funUrgeList(){
	UrlStr="JudeStyle.asp";
	newWin(UrlStr,"inputWin",500,500,50,10,"yes","no","yes","no");
	myForm.action="JudeStyle.asp";
	myForm.target="inputWin";
	myForm.submit();
	myForm.action="";
	myForm.target="";
}

function funJudesubmit(){
	winopen.close();
	if(myForm.printStyle.value=='0'){
		UrlStr="BillPrints_legal.asp";		
		newWin(UrlStr,"UrgeBat",920,600,50,10,"yes","yes","yes","no");
		myForm.action=UrlStr;
		myForm.target="UrgeBat";
		myForm.submit();
		myForm.action="";
		myForm.target="";
		setTimeout('funchgprint()',2000);
	}else{
		UrlStr="PasserJudeA4.asp?PBillSN="+myForm.PBillSN.value;
		newWin(UrlStr,"UrgeBat",920,600,50,10,"yes","yes","yes","no");
	}
}
function funchgprint(){
	winopen.DP();
}
function funchgExecel(){
	UrlStr="DCIExchangeQry_Execel.asp?SQLstr=<%=tmpSQL%>";
	newWin(UrlStr,"inputWin",700,550,50,10,"yes","yes","yes","no");
}
function funPrintDetail(){
	UrlStr="PictureDetail.htm";
	newWin(UrlStr,"inputWin",1000,800,50,10,"yes","yes","yes","no");
}
function funPrintStyle(){

		UrlStr="SendStyle.asp";
		newWin(UrlStr,"inputWin",500,500,50,10,"yes","no","yes","no");
		myForm.action="SendStyle.asp";
		myForm.target="inputWin";
		myForm.submit();
		myForm.action="";
		myForm.target="";
}
//大宗郵件
function funMailList(){
	if (myForm.DB_Display.value==""){
			alert("請先輸入作業批號查詢欲列印大宗郵件清冊的舉發單！");
	}else{
		UrlStr="MailSendList_Select.asp?SQLstr=<%=tmpSQL%>";
		newWin(UrlStr,"MailSendList",300,125,200,100,"no","no","no","no");
	}
}
//郵費清單
function funMailMoneyList(){
	if (myForm.DB_Display.value==""){
			alert("請先輸入作業批號查詢欲列印郵費單的舉發單！");
	}else{
		UrlStr="MailMoneyList_Select.asp?SQLstr=<%=tmpSQL%>";
		newWin(UrlStr,"MailMoneyList",300,220,350,200,"no","no","no","no");
	}
}
//逕舉
function funReportSendList(){
	if (myForm.DB_Display.value==""){
			alert("請先輸入作業批號查詢欲列印逕舉移送清冊的舉發單！");
	}else{
		UrlStr="ReportSendList_Excel.asp?SQLstr=<%=tmpSQL%>";
		newWin(UrlStr,"inputWin2",800,700,0,0,"yes","yes","yes","no");
	}
}
//攔停
function funStopSendList(){
	if (myForm.DB_Display.value==""){
			alert("請先輸入作業批號查詢欲列印攔停移送清冊的舉發單！");
	}else{
		UrlStr="StopSendList_Excel.asp?SQLstr=<%=tmpSQL%>";
		newWin(UrlStr,"inputWin3",800,700,0,0,"yes","yes","yes","no");
	}
}
//有效清冊
function funValidSendList(){
	if (myForm.DB_Display.value==""){
			alert("請先輸入作業批號查詢欲列印有效清冊的舉發單！");
	}else{
		UrlStr="ValidSendList_Excel.asp?SQLstr=<%=tmpSQL%>";
		newWin(UrlStr,"inputWin4",800,700,0,0,"yes","yes","yes","no");
	}
}
//無效清冊
function funUselessSendList(){
	if (myForm.DB_Display.value==""){
			alert("請先輸入作業批號查詢欲列印無效清冊的舉發單！");
	}else{
		UrlStr="UselessSendList_Excel.asp?SQLstr=<%=tmpSQL%>";
		newWin(UrlStr,"inputWin5",800,700,0,0,"yes","yes","yes","no");
	}
}
//結案清冊
function funCaseCloseSendList(){
	if (myForm.DB_Display.value==""){
			alert("請先輸入作業批號查詢欲列印無效清冊的舉發單！");
	}else{
		UrlStr="CaseCloseSendList_Excel.asp?SQLstr=<%=tmpSQL%>";
		newWin(UrlStr,"CaseCloseWin5",800,700,0,0,"yes","yes","yes","no");
	}
}
//退件清冊
function funReturnSendList(){
	if (myForm.DB_Display.value==""){
			alert("請先輸入作業批號查詢欲列印退件清冊的舉發單！");
	}else{
		UrlStr="ReturnSendList_Excel.asp?SQLstr=<%=tmpSQL%>";
		newWin(UrlStr,"inputWin6",800,700,0,0,"yes","yes","yes","no");
	}
}
//寄存送達清冊
function funStoreSendList(){
	if (myForm.DB_Display.value==""){
			alert("請先輸入作業批號查詢欲列印寄存送達清冊的舉發單！");
	}else{
		UrlStr="funStoreSendList_Excel.asp?SQLstr=<%=tmpSQL%>";
		newWin(UrlStr,"inputWin7",800,700,0,0,"yes","yes","yes","no");
	}
}
//公示送達清冊
function funGovSendList(){
	if (myForm.DB_Display.value==""){
			alert("請先輸入作業批號查詢欲列印公示送達清冊的舉發單！");
	}else{
		UrlStr="funGovSendList_Excel.asp?SQLstr=<%=tmpSQL%>";
		newWin(UrlStr,"inputWin8",800,700,0,0,"yes","yes","yes","no");
	}
}
//車籍查詢
function funchgCarDataList(){
	if (myForm.DB_Display.value==""){
		alert("請先輸入作業批號查詢欲列印車籍清冊的舉發單！");
	}else{
		UrlStr="DciPrintCarDataList.asp?SQLstr=<%=strwhereToPrintCarData%>";
		newWin(UrlStr,"DciCarListWin",790,575,50,10,"yes","no","yes","no");
	}
}
function funBillMailInfoMark(){
	if (myForm.DB_Display.value==""){
			alert("請先輸入作業批號查詢欲郵寄日期註記！");
	}else{
		UrlStr="BillMailInfoMark.asp";
		newWin(UrlStr,"inputWin",500,500,50,10,"yes","no","yes","no");
		myForm.action="BillMailInfoMark.asp";
		myForm.target="inputWin";
		myForm.submit();
		myForm.action="";
		myForm.target="";
	}
}
function funDbMove(MoveCnt){
	if (eval(MoveCnt)>0){
		if (eval(myForm.DB_Move.value) < eval(myForm.DB_Cnt.value)-10-eval(myForm.sys_MoveCnt.value)){
			myForm.DB_Move.value=eval(myForm.DB_Move.value)+MoveCnt+eval(myForm.sys_MoveCnt.value);
			myForm.submit();
		}
	}else{
		if (eval(myForm.DB_Move.value)>0){
			myForm.DB_Move.value=eval(myForm.DB_Move.value)+MoveCnt-eval(myForm.sys_MoveCnt.value);
			myForm.submit();
		}
	}
}
function repage(){
	myForm.DB_Move.value=0;
	myForm.submit();
}
</script>
<%conn.close%>