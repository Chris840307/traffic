<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
"http://www.w3.org/TR/html4/loose.dtd">
<%
fMnoth=month(now)
if fMnoth<10 then fMnoth="0"&fMnoth
fDay=day(now)
if fDay<10 then	fDay="0"&fDay
fname=year(now)&fMnoth&fDay&"_慢車行人道路障礙舉發單.xls"
Response.AddHeader "Content-Disposition", "filename="&fname
response.contenttype="application/x-msexcel; charset=MS950" 
%>
<!--#include virtual="traffic/Common/Login_Check.asp"-->
<!--#include virtual="traffic/Common/DB.ini"-->
<!--#include virtual="traffic/Common/AllFunction.inc"-->
<%
Server.ScriptTimeout = 68000
Response.flush



strCity="select value from Apconfigure where id=31"
set rsCity=conn.execute(strCity)
sys_City=trim(rsCity("value"))
rsCity.close

'檢查是否可進入本系統
	strSQLTemp="select distinct a.SN,a.IllegalDate,a.BillNo,a.Driver,a.DriverBirth,a.DriverID,a.DriverAddress,a.IllegalAddress,a.BillFillDate,a.DeallIneDate,a.Memberstation,a.Rule1,a.Rule2,a.Rule3,a.Rule4,a.RuleVer,a.FORFEIT1,a.FORFEIT2,a.FORFEIT3,a.FORFEIT4,a.BILLSTATUS,a.BillMem1,a.DoubleCheckStatus,b.JUDEDATE,c.SENDDATE,d.URGEDATE,f.PayDate,f.PayNo,g.UnitName from PasserBase a,(Select billsn,JudeDate from PasserJude) b,(Select billsn,SendDate,MakeSureDate from PasserSend) c,(Select billsn,UrgeDate from PasserUrge) d,(select PasserSN,Max(ArrivedDate) ArrivedDate from PassersEndArrived group by PasserSN) e,(select distinct BillSN,PayNo,PayDate from PasserPay) f,UnitInfo g where a.RecordStateID=0 and a.billUnitID=g.UnitID and a.SN=b.BillSN(+) and a.SN=c.BillSN(+) and a.SN=d.BillSN(+) and a.SN=e.PasserSN(+) and a.SN=f.BillSN(+) "&trim(request("SQLstr"))&trim(request("orderstr"))

	If sys_City="台南市" Then ConnExecute "慢車匯出："&strSQLTemp ,360	

%>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=big5">
<style type="text/css">
<!--
.style2 {font-size: 14px;mso-style-parent:style0;mso-number-format:"\@";}
-->
</style>
<title>慢車行人道路障礙舉發單查詢</title>
</head>
<body>
<table width="100%" border="1">
	<tr>
		<td height="26" align="center"><strong>舉發單紀錄列表</strong></td>
	</tr>
	<tr>
		<td>
			<table width="100%" border="1" cellpadding="4" cellspacing="1">
				<tr>
					<th>違規日期</th>
					<th>違規時間</th>
					<th>舉發單號</th>
					<th>舉發單位</th>
					<th>舉發人</th>
					<th>違規人</th>
					<th>違規人出生日</th>
					<th>違規人身份證字號</th>
					<th>違規人地址</th>
					<th>違規地點</th>
					<th>法條</th>
					<th>罰款</th>
					<th>填單日</th>
					<th>應到案日期</th>
					<th>應到案處所</th>
					<th>催告日</th>
					<th>裁決日</th>
					<th>移送日</th>
					<th>送達日</th>
					<th>付費日</th>
					<th>繳費字號</th>
					<th>已繳金額</th>
					<th>結案狀態</th>
				</tr>
				<%
				set rsfound=conn.execute(strSQLTemp)
				while Not rsfound.eof
					response.write "<tr>"
					response.write "<td>"&gInitDT(trim(rsfound("IllegalDate")))& "</td>"
					response.write "<td>"&hour(rsfound("IllegalDate"))&":"&Minute(rsfound("IllegalDate"))&"</td>"
					response.write "<td>"&trim(rsfound("BillNo"))&"</td>"
					response.write "<td>"&trim(rsfound("UnitName"))&"</td>"
					response.write "<td>"&trim(rsfound("BillMem1"))&"</td>"
					response.write "<td>"&trim(rsfound("Driver"))&"</td>"
					response.write "<td>"&gInitDT(trim(rsfound("DriverBirth")))&"</td>"
					response.write "<td>"&trim(rsfound("DriverID"))&"</td>"
					response.write "<td>"&trim(rsfound("DriverAddress"))&"</td>"
					response.write "<td>"&trim(rsfound("IllegalAddress"))&"</td>"

					chRule=trim(rsfound("Rule1"))
					if rsfound("Rule2")<>"" then chRule=chRule&"，"&rsfound("Rule2")
					if rsfound("Rule3")<>"" then chRule=chRule&"，"&rsfound("Rule3")
					if rsfound("Rule4")<>"" then chRule=chRule&"，"&rsfound("Rule4")

					FORFEIT=cdbl("0"&rsfound("FORFEIT1"))

					if rsfound("FORFEIT2")<>"" then
						FORFEIT=FORFEIT+cdbl("0"&rsfound("FORFEIT2"))
					end if

					if rsfound("FORFEIT3")<>"" then
						FORFEIT=FORFEIT+cdbl("0"&rsfound("FORFEIT3"))
					end if

					if rsfound("FORFEIT4")<>"" then
						FORFEIT=FORFEIT+cdbl("0"&rsfound("FORFEIT4"))
					end if

					response.write "<td>"&chRule&"</td>"
					response.write "<td>"&FORFEIT&"</td>"
					response.write "<td>"&gInitDT(trim(rsfound("BillFillDate")))&"</td>"
					response.write "<td>"&gInitDT(trim(rsfound("DeallIneDate")))&"</td>"
					response.write "<td>"
					If trim(rsfound("MemberStation"))<>"" Then
						strMS="select * from UnitInfo where UnitID='"&trim(rsfound("MemberStation"))&"'"
						Set rsMs=conn.execute(strMS)
						If Not rsMs.eof Then
							response.write Trim(rsMs("UnitName"))
						End if
						rsMs.close
						Set rsMs=nothing
					End If 
					response.write "</td>"
					response.write "<td>"&trim(gInitDT(rsfound("URGEDATE")))&"</td>"
					response.write "<td>"&trim(gInitDT(rsfound("JUDEDATE")))&"</td>"
					strSD="select min(SendDate) as SendDate from PasserSendDetail where BillSn="&Trim(rsfound("sn"))&" and SendDate is not null"
					Set rsSD=conn.execute(strSD)
					If Not rsSD.eof then	
						SENDDATEtmp=Trim(rsSD("SendDate"))
					End If
					rsSD.close
					Set rsSD=Nothing 
					If SENDDATEtmp="" Then
						strSD2="select * from PasserSend where BillSn="&Trim(rsfound("sn"))
						Set rsSD2=conn.execute(strSD2)
						If Not rsSD2.eof Then
							SENDDATEtmp=Trim(rsSD2("SendDate"))
						End If
						rsSD2.close
						Set rsSD2=Nothing 
					End If 
					response.write "<td>"&trim(gInitDT(SENDDATEtmp))&"</td>"
					strSQL="Select PASSERSN,Max(ARRIVEDDATE) as ARRIVEDDATE from PassersEndArrived where PasserSN="&rsfound("SN")&" group by PASSERSN"
					set rssend=conn.execute(strSQL)
					ARRIVEDDATE=""
					if Not rssend.eof then ARRIVEDDATE=trim(gInitDT(rssend("ARRIVEDDATE")))
					rssend.close
					response.write "<td>"&ARRIVEDDATE&"</td>"

					response.write "<td>"&trim(gInitDT(rsfound("PayDate")))&"</td>"
					response.write "<td class=""style2"">"&trim(rsfound("PayNo"))&"</td>"

					Sys_Payamount=0
					strSQL="select Payamount as Sys_Payamount from PasserPay where BillSN="&rsfound("SN")&" and BillNo='"&rsfound("BillNo")&"' and payno='"&rsfound("PayNo")&"'"
					set rspay=conn.execute(strSQL)
					if not rspay.eof then Sys_Payamount=rspay("Sys_Payamount")
					rspay.close

					If ifnull(Sys_Payamount) Then Sys_Payamount=0					

					response.write "<td>"&cdbl(Sys_Payamount)&"</td>"

					if trim(rsfound("BILLSTATUS"))="9" then
						response.write "<td>已結案</td>"
					else
						response.write "<td>未結案</td>"
					end if
					response.write "</tr>"
					rsfound.MoveNext
				wend
				rsfound.close
				set rsfound=nothing
				%>
			</table>
		</td>
	</tr>
</table>
</body>
</html>
<%
conn.close
set conn=nothing
%>